version: '3'

# CardMint Task Runner - Wright Brothers Edition
# Unified interface for all CardMint operations
# Usage: task <command> or install with: npm install -g @go-task/cli

vars:
  PROJECT_NAME: CardMint
  VERSION: 2.0.0
  NODE_ENV: development

tasks:
  # ==============================================================================
  # SYSTEM SETUP & HEALTH CHECKS
  # ==============================================================================
  
  up:
    desc: "üöÄ Start all CardMint services and verify system health"
    cmds:
      - echo "üöÄ Starting CardMint production system..."
      - task: health
      - echo "‚úÖ All systems verified - starting services"
      - npm run dev

  health:
    desc: "üè• Complete system health check (config, ML, camera, database)"
    cmds:
      - echo "üè• Running comprehensive system health check..."
      - task: config:doctor
      - task: camera:diag
      - task: golden:validate
      - echo "‚úÖ System health check completed"

  doctor:
    desc: "ü©∫ Quick system diagnosis for production readiness"
    cmds:
      - echo "ü©∫ CardMint Production Readiness Check"
      - echo "======================================"
      - task: config:doctor
      - echo ""
      - echo "üîã Services Status:"
      - curl -sf http://localhost:3000/api/health > /dev/null && echo "‚úÖ CardMint API" || echo "‚ùå CardMint API (not running)"
      - curl -sf http://10.0.24.174:1234/v1/models > /dev/null && echo "‚úÖ LMStudio ML" || echo "‚ùå LMStudio ML (not reachable)"
      - redis-cli ping > /dev/null 2>&1 && echo "‚úÖ Redis" || echo "‚ùå Redis (not running)"

  # ==============================================================================
  # CONFIGURATION MANAGEMENT  
  # ==============================================================================
  
  config:doctor:
    desc: "üîß Validate configuration and connectivity"
    cmd: npm run config:doctor

  # ==============================================================================
  # GOLDEN DATASET & TESTING
  # ==============================================================================
  
  golden:validate:
    desc: "üèÜ Validate golden test dataset schema"
    cmd: npm run golden:validate

  golden:test:
    desc: "üéØ Run golden accuracy tests (minimum viable accuracy)"
    cmds:
      - echo "üéØ Running Golden Accuracy Tests"
      - echo "Target: 95%+ accuracy, ‚â§3000ms processing"
      - echo ""
      - npm run golden:test

  test:e2e:
    desc: "üîÑ Full end-to-end pipeline test"
    cmd: ./scripts/test-e2e-pipeline.sh

  test:accuracy:
    desc: "üìä Accuracy evaluation against ground truth"
    cmd: node scripts/test-accuracy-suite.js

  benchmark:
    desc: "‚ö° Performance benchmarking"
    cmd: node scripts/benchmark-throughput.js

  # ==============================================================================
  # CAMERA MANAGEMENT
  # ==============================================================================
  
  camera:diag:
    desc: "üì∏ Sony camera comprehensive diagnostics"
    cmd: npm run camera:diag

  camera:reset:
    desc: "üîÑ Sony camera reset and recovery"
    cmd: npm run camera:reset

  camera:test:
    desc: "üì∑ Test camera connectivity and capture"
    cmd: npm run camera:test

  camera:build:
    desc: "üî® Build Sony camera SDK components"
    cmd: npm run camera:build

  # ==============================================================================
  # ML & LMSTUDIO MANAGEMENT
  # ==============================================================================
  
  ml:test:
    desc: "üß† Test ML server connectivity and performance"
    cmd: ./scripts/test-ml-connectivity.sh

  ml:bench:
    desc: "üìà Benchmark ML processing performance"
    cmds:
      - echo "üìà ML Performance Benchmark"
      - echo "Target: 2-3s per card, 95%+ accuracy"
      - ./scripts/test-single-card.sh

  ml:health:
    desc: "üíö Check ML server health and circuit breaker status"
    cmd: ./scripts/test-ml-health.sh

  # ==============================================================================
  # DATABASE & STORAGE
  # ==============================================================================
  
  db:check:
    desc: "üóÑÔ∏è Check database connectivity and status"
    cmds:
      - echo "üóÑÔ∏è Database Status Check"
      - echo "SQLite Database: ./data/cardmint.db"
      - test -f ./data/cardmint.db && echo "‚úÖ Database file exists" || echo "‚ùå Database file missing"
      - sqlite3 ./data/cardmint.db "SELECT COUNT(*) as card_count FROM cards;" 2>/dev/null && echo "‚úÖ Database accessible" || echo "‚ùå Database access failed"

  archive:
    desc: "üì¶ Run storage archival process"
    cmd: ./scripts/daily-archive.sh

  # ==============================================================================
  # DEVELOPMENT COMMANDS
  # ==============================================================================
  
  dev:
    desc: "üíª Start development server with hot reload"
    cmd: npm run dev

  build:
    desc: "üî® Build production assets"
    cmd: npm run build

  test:
    desc: "üß™ Run test suite"
    cmd: npm test

  lint:
    desc: "‚ú® Lint and format code"
    cmd: npm run lint

  # ==============================================================================
  # PRODUCTION OPERATIONS
  # ==============================================================================
  
  deploy:
    desc: "üö¢ Deploy to production (with safety checks)"
    cmds:
      - echo "üö¢ Production Deployment Checklist"
      - task: golden:test
      - task: health
      - echo "‚úÖ All safety checks passed - ready for deployment"

  reset:
    desc: "üîÑ Complete system reset (camera, ML, services)"
    cmds:
      - echo "üîÑ Complete CardMint System Reset"
      - echo "================================="
      - task: camera:reset
      - echo ""
      - echo "üß† ML Service Reset:"
      - curl -X POST http://10.0.24.174:5002/reset 2>/dev/null || echo "‚ö†Ô∏è  ML service reset endpoint not available"
      - echo ""
      - echo "üîÑ Restarting services..."
      - pkill -f "cardmint" || true
      - sleep 2
      - echo "‚úÖ System reset completed - run 'task up' to restart"

  status:
    desc: "üìä Show current system status and metrics"
    cmds:
      - echo "üìä CardMint System Status"
      - echo "========================"
      - echo "üîã Service Status:"
      - curl -sf http://localhost:3000/api/health > /dev/null && echo "  ‚úÖ CardMint API (http://localhost:3000)" || echo "  ‚ùå CardMint API (not running)"
      - curl -sf http://10.0.24.174:1234/v1/models > /dev/null && echo "  ‚úÖ LMStudio ML (http://10.0.24.174:1234)" || echo "  ‚ùå LMStudio ML (check Mac connectivity)"
      - redis-cli ping > /dev/null 2>&1 && echo "  ‚úÖ Redis (localhost:6379)" || echo "  ‚ùå Redis (not running)"
      - echo ""
      - echo "üéØ Golden Test Status:"
      - test -f tests/e2e/golden/manifest.json && echo "  ‚úÖ 10 verified cards ready" || echo "  ‚ùå Golden dataset missing"
      - echo ""
      - echo "üì∏ Camera Status:"
      - /home/profusionai/CardMint/CrSDK_v2.00.00_20250805a_Linux64PC/build/sony-cli list > /dev/null 2>&1 && echo "  ‚úÖ Sony camera connected" || echo "  ‚ùå Sony camera not detected"

  # ==============================================================================
  # MONITORING & METRICS
  # ==============================================================================
  
  dash:
    desc: "üñ•Ô∏è Open verification dashboard in browser"
    cmds:
      - echo "üñ•Ô∏è Opening CardMint Dashboard..."
      - xdg-open http://localhost:3000/dashboard/verification.html 2>/dev/null || echo "Dashboard available at: http://localhost:3000/dashboard/verification.html"

  logs:
    desc: "üìã View system logs"
    cmds:
      - echo "üìã Recent CardMint Logs"
      - echo "====================="
      - tail -n 20 logs/cardmint.log 2>/dev/null || echo "No logs found - start services first"

  metrics:
    desc: "üìà Show performance metrics"
    cmds:
      - echo "üìà CardMint Performance Metrics"
      - echo "==============================="
      - curl -s http://localhost:9091/metrics 2>/dev/null | grep cardmint | head -10 || echo "Metrics not available - start services first"

  # ==============================================================================
  # UTILITY COMMANDS
  # ==============================================================================
  
  clean:
    desc: "üßπ Clean temporary files and caches"
    cmds:
      - echo "üßπ Cleaning temporary files..."
      - rm -rf node_modules/.cache dist/*.map logs/temp* || true
      - echo "‚úÖ Cleanup completed"

  install:
    desc: "üì¶ Install dependencies and setup system"
    cmds:
      - echo "üì¶ Installing CardMint dependencies..."
      - npm install
      - task: camera:build
      - echo "‚úÖ Installation completed"

  # ==============================================================================
  # HELP & DOCUMENTATION
  # ==============================================================================
  
  help:
    desc: "‚ùì Show detailed help and common workflows"
    cmds:
      - echo "üéØ CardMint Task Runner - Common Workflows"
      - echo "=========================================="
      - echo ""
      - echo "üöÄ GETTING STARTED:"
      - echo "  task up              # Start all services with health checks"
      - echo "  task status          # Check system status"
      - echo "  task dash            # Open verification dashboard"
      - echo ""
      - echo "üß™ TESTING & VALIDATION:"
      - echo "  task golden:test     # Run accuracy tests (95%+ target)"
      - echo "  task test:e2e        # Full pipeline test"
      - echo "  task benchmark       # Performance benchmarking"
      - echo ""
      - echo "üì∏ CAMERA MANAGEMENT:"
      - echo "  task camera:diag     # Camera diagnostics"
      - echo "  task camera:reset    # Reset camera connection"
      - echo "  task camera:test     # Test camera capture"
      - echo ""
      - echo "üß† ML & PROCESSING:"
      - echo "  task ml:test         # Test LMStudio connectivity"
      - echo "  task ml:bench        # ML performance benchmark"
      - echo ""
      - echo "üîß SYSTEM MAINTENANCE:"
      - echo "  task health          # Complete health check"
      - echo "  task reset           # Full system reset"
      - echo "  task deploy          # Production deployment"
      - echo ""
      - echo "üìö For detailed help: https://github.com/cardmint/docs"

  version:
    desc: "‚ÑπÔ∏è Show CardMint version and system info"
    cmds:
      - echo "CardMint {{.PROJECT_NAME}} v{{.VERSION}}"
      - echo "Wright Brothers Edition - Production Ready"
      - echo ""
      - echo "System Information:"
      - echo "  Node.js: $(node --version)"
      - echo "  NPM: $(npm --version)"
      - echo "  OS: $(uname -sr)"
      - echo "  Architecture: $(uname -m)"
      - echo ""
      - echo "Core Components:"
      - echo "  ‚úÖ Typed Config Validation (Zod)"
      - echo "  ‚úÖ Trace ID System"
      - echo "  ‚úÖ Circuit Breaker (LMStudio)"
      - echo "  ‚úÖ Golden Test Dataset (10 cards)"
      - echo "  ‚úÖ Sony Camera Diagnostics"
      - echo "  ‚úÖ Wright Brothers Precision Engineering"

# Default task when running just 'task'
default: help