# Release prod-2025-12-27a

**Date:** 2025-12-27
**Type:** Feature release
**Rollback posture:** Forward-only (schema changes); code rollback leaves schema intact

## Summary

Major release consolidating the fulfillment pipeline (PR1-PR3), capture/calibration system,
frontend UI updates, ESP32 hardware integration, and infrastructure tooling.

## Features

### Fulfillment Pipeline (PR1-PR3)

- **Orders table with human-readable order numbers** (`CM-YYYYMMDD-XXXX` format)
  - Links Stripe sessions to fulfillment records
  - Provides customer-facing order identifiers for support

- **Email outbox + Resend worker**
  - Transactional email queue with retry logic
  - Two-email model: confirmation at checkout, tracking when shipped
  - Resend integration via REST API (no SDK dependency)

- **Resend endpoint** (`POST /api/fulfillment/:id/resend-email`)
  - Manual retry for failed emails
  - Returns 200/202/409 based on outbox status

- **Auto-fulfillment worker**
  - Background job for automated fulfillment processing

- **EasyPost integration**
  - Label purchase and tracking number generation
  - Carrier rate comparison

- **Reservation expiry job**
  - Cleans up abandoned cart reservations

### Capture/Calibration System

- **Calibration routes and repository**
  - Store and retrieve camera calibration data
  - Calibration cleanup job for stale entries

- **Capture settings routes**
  - Runtime capture configuration API

- **Pi5 kiosk driver updates**
  - Improved capture adapter integration

### Frontend

- **API client updates**
  - New endpoints for fulfillment and calibration

- **Session header improvements**
  - Enhanced operator workflow display

- **Calibration modal**
  - UI for camera calibration workflow

### Hardware

- **ESP32 Stock Display** (`hardware/stock-display/`)
  - Real-time inventory display on ESP32-2432S028R (Cheap Yellow Display)
  - PlatformIO firmware with HTTPS, TFT rendering, auto-refresh
  - Connects to `/api/stock-summary/compact`

### Infrastructure

- **Internal Debug API** (`apps/internal-debug-api/`)
  - Read-only ops tool for production debugging
  - Allowlisted endpoints, no write operations

- **Dev tooling scripts**
  - `dev-start.sh`, `dev-stop.sh`, `dev-logs.sh`, `dev-status.sh`
  - `health_check.sh`, `verify_assets.sh`, `setup_env.sh`
  - `generate-local-certs.sh`

- **Nginx config** (`nginx.conf`)
  - Local development proxy configuration

### EverShop

- **Dockerfile updates** for CardMint customizations
- **Submodule pointer update** to latest cardmint-shop
- **Version 1.1.0 migration** for sync state

## Migrations

New migrations (forward-only, applied in order):

| Migration | Purpose |
|-----------|---------|
| `20251218c_cart_reservation.sql` | Cart reservation tracking |
| `20251218d_reconcile_sync_checksum.sql` | Sync reconciliation checksums |
| `20251223_easypost_integration.sql` | EasyPost shipment tracking fields |
| `20251224_capture_calibration.sql` | Camera calibration storage |
| `20251225_orders_table.sql` | Orders with human-readable numbers (already applied) |
| `20251226_email_outbox.sql` | Email outbox queue |
| `20251226b_email_outbox_upgrade.sql` | Two-email model fields |
| `20251226_fulfillment_processing_status.sql` | Fulfillment state machine |
| `20251227_order_events_email_resend.sql` | Email resend event tracking |

**Note:** `*_down.sql` files are present for reference but skipped by `migrate.ts` (line 94 filter).

## Deploy Checklist

1. Take btrfs snapshot before deploy
2. `git pull` on production
3. `cd apps/backend && npm ci` (lockfile changed)
4. `npm run migrate`
5. Restart backend: `sudo systemctl restart cardmint-backend`
6. Verify: `curl localhost:4000/health`

## Verification

- [ ] `/health` returns `status: ok`
- [ ] Fulfillment list shows `orderNumber` field
- [ ] Resend endpoint returns appropriate status codes
- [ ] `order_events` table accepts `email_resend_triggered` type
- [ ] ESP32 display updates from `/api/stock-summary/compact`

## Breaking Changes

None. All changes are additive.

## Known Issues

None identified.

---

Generated with Claude Code
