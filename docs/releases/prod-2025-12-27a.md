# Release prod-2025-12-27a

**Date:** 2025-12-27
**Type:** Feature release
**Rollback posture:** Forward-only (schema changes); code rollback leaves schema intact

## Summary

Major release consolidating the fulfillment pipeline (PR1-PR3), capture/calibration system,
frontend UI updates, ESP32 hardware integration, infrastructure tooling, and security hardening.

## Features

### Fulfillment Pipeline (PR1-PR3)

- **Orders table with human-readable order numbers** (`CM-YYYYMMDD-XXXX` format)
  - Links Stripe sessions to fulfillment records
  - Provides customer-facing order identifiers for support

- **Email outbox + Resend worker**
  - Transactional email queue with retry logic
  - Two-email model: confirmation at checkout, tracking when shipped
  - Resend integration via REST API (no SDK dependency)

- **Resend endpoint** (`POST /api/fulfillment/:id/resend-email`)
  - Manual retry for failed emails
  - Returns 200/202/409 based on outbox status

- **Auto-fulfillment worker**
  - Background job for automated fulfillment processing

- **EasyPost integration**
  - Label purchase and tracking number generation
  - Carrier rate comparison

- **Reservation expiry job**
  - Cleans up abandoned cart reservations

### Capture/Calibration System

- **Calibration routes and repository**
  - Store and retrieve camera calibration data
  - Calibration cleanup job for stale entries

- **Capture settings routes**
  - Runtime capture configuration API

- **Pi5 kiosk driver updates**
  - Improved capture adapter integration

### Frontend

- **API client updates**
  - New endpoints for fulfillment and calibration

- **Session header improvements**
  - Enhanced operator workflow display

- **Calibration modal**
  - UI for camera calibration workflow

### Hardware

- **ESP32 Stock Display** (`hardware/stock-display/`)
  - Real-time inventory display on ESP32-2432S028R (Cheap Yellow Display)
  - PlatformIO firmware with HTTPS, TFT rendering, auto-refresh
  - Connects to `/api/stock-summary/compact`

### Infrastructure

- **Internal Debug API** (`apps/internal-debug-api/`)
  - Read-only ops tool for production debugging
  - Allowlisted endpoints, no write operations

- **Dev tooling scripts**
  - `dev-start.sh`, `dev-stop.sh`, `dev-logs.sh`, `dev-status.sh`
  - `health_check.sh`, `verify_assets.sh`, `setup_env.sh`
  - `generate-local-certs.sh`

- **Nginx config** (`nginx.conf`)
  - Local development proxy configuration

### EverShop

- **Dockerfile updates** for CardMint customizations
- **Submodule pointer update** to latest cardmint-shop
- **Version 1.1.0 migration** for sync state

### Security Hardening (Codex Review)

- **Admin endpoint authentication** (`/api/admin/*`)
  - Bearer token auth via `CARDMINT_ADMIN_API_KEY`
  - Constant-time comparison to prevent timing attacks
  - 401 for missing/invalid token, 503 if key not configured

- **Localhost endpoint hardening** (capture/calibration)
  - Two-layer protection: `req.socket.remoteAddress` check + `X-CardMint-Internal` header
  - Prevents X-Forwarded-For spoofing attacks
  - Protects `/api/capture/*` and `/api/calibration/*` routes

- **Stock display token gating**
  - `X-CardMint-Display-Token` header required when `DISPLAY_TOKEN` is set
  - Backward compatible: endpoints remain public if token not configured
  - Protects inventory visibility from unauthorized access

- **Nginx routing update**
  - Added `/api/admin/` â†’ CardMint backend (port 4000)
  - Previously fell through to EverShop (port 3000)

- **sold_price units fix**
  - `sold_price` now stored in cents (was dollars)
  - `sold_today_cents` calculation corrected (removed double `* 100`)

## Migrations

New migrations (forward-only, applied in order):

| Migration | Purpose |
|-----------|---------|
| `20251218c_cart_reservation.sql` | Cart reservation tracking |
| `20251218d_reconcile_sync_checksum.sql` | Sync reconciliation checksums |
| `20251223_easypost_integration.sql` | EasyPost shipment tracking fields |
| `20251224_capture_calibration.sql` | Camera calibration storage |
| `20251225_orders_table.sql` | Orders with human-readable numbers (already applied) |
| `20251226_email_outbox.sql` | Email outbox queue |
| `20251226b_email_outbox_upgrade.sql` | Two-email model fields |
| `20251226_fulfillment_processing_status.sql` | Fulfillment state machine |
| `20251227_order_events_email_resend.sql` | Email resend event tracking |

**Note:** `*_down.sql` files are present for reference but skipped by `migrate.ts` (line 94 filter).

## Deploy Checklist

### Pre-deploy (REQUIRED)

1. **Take btrfs snapshot:**
   ```bash
   sudo btrfs subvolume snapshot /var/www/cardmint-backend /snapshots/pre-prod-2025-12-27a
   ```

2. **Backup database file:**
   ```bash
   cp /var/www/cardmint-backend/cardmint_prod.db /backups/cardmint_prod.db.pre-2025-12-27a
   ```

### Deploy

3. `git pull` on production
4. `cd apps/backend && npm ci` (lockfile changed)
5. `npm run migrate`
6. Restart backend: `sudo systemctl restart cardmint-backend`
7. Verify: `curl localhost:4000/health`

### New Environment Variables

Added to `/etc/cardmint-backend.env` on 2025-12-25:

| Variable | Purpose | Required |
|----------|---------|----------|
| `CARDMINT_ADMIN_API_KEY` | Bearer token for `/api/admin/*` endpoints | **Yes** (configured) |
| `CAPTURE_INTERNAL_KEY` | Secret header for calibration/capture endpoints | **Yes** (configured) |
| `DISPLAY_TOKEN` | Token for `/api/stock-summary/*` endpoints | **Yes** (configured) |

**Note:** ESP32 firmware must be updated to send `X-CardMint-Display-Token` header.

## Rollback Procedure

This release uses forward-only migrations. Rollback requires restoring from snapshot.

### Full Rollback Steps

1. **Stop the backend:**
   ```bash
   sudo systemctl stop cardmint-backend
   ```

2. **Verify no in-flight transactions:**
   ```bash
   sqlite3 /var/www/cardmint-backend/cardmint_prod.db "SELECT * FROM email_outbox WHERE status='sending'"
   ```

3. **Restore from btrfs snapshot:**
   ```bash
   sudo btrfs subvolume delete /var/www/cardmint-backend
   sudo btrfs subvolume snapshot /snapshots/pre-prod-2025-12-27a /var/www/cardmint-backend
   ```

   **OR** restore from DB file backup (code already rolled back):
   ```bash
   cp /backups/cardmint_prod.db.pre-2025-12-27a /var/www/cardmint-backend/cardmint_prod.db
   ```

4. **Rollback code:**
   ```bash
   git checkout prod-2025-12-26  # or previous known-good tag
   ```

5. **Restart:**
   ```bash
   sudo systemctl start cardmint-backend
   curl localhost:4000/health
   ```

### Code-Only Rollback (Schema Preserved)

If only code changes need to be reverted (schema migrations are backward compatible):

1. `git checkout prod-2025-12-26`
2. `sudo systemctl restart cardmint-backend`

Note: Some features may show errors if code expects columns that don't exist in old schema.

## Verification

### Core Functionality
- [x] `/health` returns `status: ok`
- [ ] Fulfillment list shows `orderNumber` field
- [ ] Resend endpoint returns appropriate status codes
- [ ] `order_events` table accepts `email_resend_triggered` type

### Security (verified 2025-12-25)
- [x] `/api/admin/*` returns 401 without Bearer token
- [x] `/api/admin/*` returns item data with valid Bearer token
- [x] `/api/stock-summary/compact` returns 401 without `X-CardMint-Display-Token`
- [x] `/api/stock-summary/compact` returns JSON with valid token
- [ ] ESP32 display sends token header (firmware update pending)

## Breaking Changes

None. All changes are additive.

## Known Issues

None identified.

---

Generated with Claude Code
