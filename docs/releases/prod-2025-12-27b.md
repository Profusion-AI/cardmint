# Release prod-2025-12-27b

**Date:** 2025-12-27
**Type:** Guardrail + sync release
**Rollback posture:** Forward-only (schema changes); code rollback leaves schema intact

## Summary

Hardens the authority boundary so hidden products stay hidden (and non-purchasable) across PDP, feeds, cart, and checkout. Adds Atlas lint/drift gates to prevent schema drift during refactors, plus production config fail-fast for `SQLITE_DB`.

## Changes

### Authority Boundary (Customer-Facing)

- **Public visibility + purchase rule:** Only products with `evershop_sync_state='evershop_live'` are visible/purchasable.
- Enforced at:
  - `GET /api/products/:slug` (PDP)
  - `GET /api/public-feed` (public feeds)
  - `POST /api/cart/reserve` + `POST /api/cart/validate`
  - Stripe checkout session creation (single + multi) and lot preview
- Blocked requests return **404** with a short **reference code** for support escalation; internal logs include `{ productUid, internalReason, syncState }`.

### Atlas (Schema “Truth Detector”)

- Adds **blocking CI** for Atlas migration lint + drift detection (`.github/workflows/atlas-lint.yml`).
- Baseline regeneration is now **deterministic**: builds a fresh DB via `migrate.ts`, then extracts filtered schema (`apps/backend/scripts/regenerate-baseline.sh`).

### Config Hardening

- Backend now **fails fast in production** if `SQLITE_DB` is unset, missing, or points to an uninitialized schema.
- Logs a **one-time production warning** if `DISPLAY_TOKEN` is unset (stock display endpoints remain backward-compatible unless token is configured).

### Misc Sync

- ImageKit transform update (`e-retouch` → `e-sharpen`).
- EverShop Grid custom thumbnail component.
- ESP32 stock display header support for `X-CardMint-Display-Token`.

## Migrations

New forward-only migrations (applied in order):

| Migration | Purpose |
|-----------|---------|
| `20251227b_scans_corrected_image_path.sql` | Reconcile `scans.corrected_image_path` for fresh DB rebuilds |
| `20251227c_products_cdn_published_at.sql` | Reconcile `products.cdn_published_at` for fresh DB rebuilds |

**Note:** `*_down.sql` files are present for reference but skipped by `migrate.ts`.

## Deploy Checklist

### Pre-deploy (REQUIRED)

1. Take btrfs snapshot:
   ```bash
   sudo btrfs subvolume snapshot /var/www/cardmint-backend /snapshots/pre-prod-2025-12-27b
   ```

2. Backup database file:
   ```bash
   cp /var/www/cardmint-backend/cardmint_prod.db /backups/cardmint_prod.db.pre-2025-12-27b
   ```

### Deploy

3. `git pull` on production
4. `cd apps/backend && npm ci`
5. `npm run migrate`
6. Restart backend: `sudo systemctl restart cardmint-backend`
7. Verify: `curl localhost:4000/health`

## Rollback Procedure

This release uses forward-only migrations. Rollback requires restoring from snapshot.

1. Stop backend: `sudo systemctl stop cardmint-backend`
2. Restore snapshot:
   ```bash
   sudo btrfs subvolume delete /var/www/cardmint-backend
   sudo btrfs subvolume snapshot /snapshots/pre-prod-2025-12-27b /var/www/cardmint-backend
   ```
3. Checkout prior tag: `git checkout prod-2025-12-27a`
4. Start backend + verify: `sudo systemctl start cardmint-backend && curl localhost:4000/health`

## Verification

- [ ] Public PDP returns 404 for non-`evershop_live` products
- [ ] Public feed does not include non-`evershop_live` products
- [ ] Cart reserve/validate rejects non-`evershop_live` products (ref code surfaced)
- [ ] Checkout session creation fails for hidden/non-live products (ref code surfaced)
- [ ] `./scripts/regenerate-baseline.sh --check` passes in CI

