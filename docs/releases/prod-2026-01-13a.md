# Release: prod-2026-01-13a

**Date:** 2026-01-13
**Type:** Feature + Security
**Complexity:** ★★★★★ (auth/session + customer-facing security)

## Summary

P1.3 Claim Order backend implementation with comprehensive security hardening based on Codex QA (RED→YELLOW→GREEN progression).

## Changes

### New Features
- **Claim Order Flow** (`/api/claim/*`)
  - `/api/claim/status` — Check if claim feature is enabled
  - `/api/claim/initiate` — Start claim by sending email link to order's email
  - `/api/claim/complete` — Complete claim using token from email
  - `/api/claim/zip-fallback` — Alternative claim via ZIP verification (requires Turnstile)

### Security Hardening (Codex QA Findings)
- **R1 (RED):** Token in URL fragment (`#token=`) instead of query string — prevents nginx access log exposure
- **Y1/Y2:** Unified error responses — all claim failures return identical 400 + `INVALID_REQUEST` (no order-existence oracles)
- **Order-existence oracle eliminated:** `/api/claim/initiate` returns 200 OK for ALL syntactically valid CM-* orders, regardless of existence/rate-limit/email-send outcome
- **Y3:** Token consume race condition fixed — checks `result.changes === 0` after UPDATE
- **Y4:** ZIP lockout comment updated to match implementation (3 attempts triggers lockout)
- **Y5:** `PUBLIC_BASE_URL` config option added with production fallback
- **IP-based rate limiting:** New `ipRateLimiter.ts` middleware prevents order enumeration via timing attacks
- **PII protection:** No email domains or masked emails stored in logs/claim_events

### Database Migrations
- `20260113_claim_tokens.sql` — Creates `claim_tokens`, `claim_rate_limits`, `claim_events` tables

### Configuration
- `CLAIM_ORDER_ENABLED` — Kill-switch (default: false)
- `CLAIM_TOKEN_TTL_MINUTES` — Token validity (default: 30)
- `CLAIM_EMAIL_RATE_LIMIT_HOURLY/DAILY` — Email send rate limits
- `CLAIM_ZIP_RATE_LIMIT_HOURLY/DAILY` — ZIP verify rate limits
- `CLAIM_ZIP_LOCKOUT_HOURS` — Lockout duration after 3 failed attempts
- `PUBLIC_BASE_URL` — Public URL for claim emails

## Files Changed

- `apps/backend/src/routes/claim.ts` — New claim routes
- `apps/backend/src/services/claimService.ts` — New claim service
- `apps/backend/src/middleware/ipRateLimiter.ts` — New IP rate limiter
- `apps/backend/src/middleware/workosAuth.ts` — WorkOS auth middleware
- `apps/backend/src/middleware/csrfProtection.ts` — CSRF protection middleware
- `apps/backend/src/config.ts` — New claim config options
- `apps/backend/src/services/resendService.ts` — Claim email template
- `apps/backend/src/app/http.ts` — Route registration
- `apps/backend/src/db/migrations/20260113_claim_tokens.sql` — Schema
- `apps/backend/.env.example` — New env vars documented

## Verification

```bash
# Backend health
ssh -i ~/.ssh/cardmint_droplet cardmint@157.245.213.233 'curl -sS localhost:4000/health | jq -r .status'
# Expected: ok

# Claim status endpoint
ssh -i ~/.ssh/cardmint_droplet cardmint@157.245.213.233 'curl -sS localhost:4000/api/claim/status | jq'
# Expected: { ok: true, enabled: false, ... }

# Production smoke
curl -Is https://cardmintshop.com/ | head -1
# Expected: HTTP/2 200
```

## Rollback

```bash
# 1. Revert to previous tag
git checkout prod-2026-01-10a  # or previous tag

# 2. Rsync and restart
rsync -avz --exclude='node_modules' --exclude='*.db*' --exclude='data' --exclude='.env' -e "ssh -i ~/.ssh/cardmint_droplet" /home/kyle/CardMint-workspace/apps/backend/ cardmint@157.245.213.233:/var/www/cardmint-backend/
ssh -i ~/.ssh/cardmint_droplet cardmint@157.245.213.233 'cd /var/www/cardmint-backend && npm ci && sudo systemctl restart cardmint-backend'

# 3. Down migration (if needed)
# Note: claim_tokens tables can be safely dropped as feature is disabled by default
ssh -i ~/.ssh/cardmint_droplet cardmint@157.245.213.233 'cd /var/www/cardmint-backend && sqlite3 cardmint_prod.db < src/db/migrations/20260113_claim_tokens_down.sql'
```

## Next Steps

- **P1.4:** Admin outer wall (nginx layer for `/api/claim/*`)
- **Frontend:** `/claim` page to parse `#token=` from URL fragment
- **Enable:** Set `CLAIM_ORDER_ENABLED=true` once frontend + outer wall complete

## Codex QA Status

- Initial review: **RED** (token in query string)
- Second review: **YELLOW** (PII logging, ZIP_MISMATCH oracle)
- Third review: **YELLOW** (order-existence oracle via status code)
- Final status: **GREEN** (all findings addressed)

---

**Deployed by:** Claude Code
**Reviewed by:** Codex (GREEN)
**Approved by:** Kyle
