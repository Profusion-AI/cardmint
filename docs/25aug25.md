# CardMint Comprehensive Audit & Architecture Cleanup
*Date: August 25, 2025*
*Status: Implementation Phase*

## Executive Summary

This document outlines the systematic transformation of CardMint from a placeholder-heavy codebase to a production-ready system with clean ports/adapters architecture, CI safety rails, and performance optimization. The approach prioritizes safety, incremental progress, and architectural integrity.

## Current State Analysis

### Technical Debt Identified
- **Placeholder Services**: Multiple incomplete implementations with "TODO" and "NOT IMPLEMENTED" markers
- **Architectural Violations**: Direct concrete imports without dependency injection
- **Legacy Code**: Outdated ML model managers and incomplete ONNX paths
- **CI Gaps**: No guards against importing deprecated code or placeholder strings
- **Performance Issues**: OCR processing taking 12-17 seconds (target: <3s)

### Critical Files Requiring Attention
```
services/model_manager_intel.py          → legacy/ml/ (placeholder)
services/smolvlm_optimized_service.py    → legacy/ml/ (incomplete ONNX)
src/ImageValidationService.ts            → legacy/validation/ (placeholder)
src/ImageProcessor.ts                    → legacy/image/ (partial impl)
```

## Implementation Phases

### Phase 0: Safety Infrastructure ✅ CRITICAL FIRST
**Objective**: Establish rollback capability and prevent production impact

#### Tasks:
1. **Git Checkpoint Creation**
   ```bash
   git switch -c cleanup/2025-08-25-deprecation
   git tag -a v0.5.0-pre-deprecation -m "Checkpoint before deprecation sweep"
   ```

2. **Archive Backup**
   ```bash
   mkdir -p ../cardmint-archives
   git archive --format=zip --output ../cardmint-archives/cardmint-predep-2025-08-25.zip HEAD \
     Taskfile.yml docker-compose*.yml package.json pnpm-lock.yaml \
     src/ scripts/ services/ docs/ config/ golden/
   git bundle create ../cardmint-archives/cardmint-2025-08-25.bundle --all
   ```

3. **Feature Flag System**
   - Create `src/config/features.ts` with environment-based toggles
   - Implement percentage-based gradual rollout (1% → 5% → 20% → 50% → 100%)
   - Add emergency disable capability

4. **Emergency Rollback Scripts**
   ```bash
   # scripts/emergency-rollback.sh
   export VLM_ENABLED=false
   export LEGACY_FALLBACK=true
   pm2 restart cardmint
   ```

### Phase 1: Deprecation Framework
**Objective**: Create quarantine system and prevent new technical debt

#### 1.1 Legacy Quarantine Structure
```
legacy/
├── ml/
│   ├── model_manager_intel.py
│   └── smolvlm_optimized_service.py
├── image/
│   └── ImageProcessor.ts
└── validation/
    └── ImageValidationService.ts
```

#### 1.2 ESLint Architecture Guards
```javascript
// .eslintrc.cjs additions
rules: {
  'import/no-restricted-paths': ['error', { 
    zones: [{ target: './src', from: './legacy' }] 
  }],
  'no-warning-comments': ['error', { 
    terms: ['TODO','FIXME','PLACEHOLDER','NOT IMPLEMENTED'], 
    location: 'anywhere' 
  }]
}
```

#### 1.3 CI Quality Gates
```yaml
# .github/workflows/quality-gates.yml
- name: Fail on placeholders in src
  run: |
    ! grep -RInE "PLACEHOLDER|NOT IMPLEMENTED|@@@TEMP@@@" \
      --include='*.{ts,tsx,py}' src/ || \
      (echo "❌ Placeholder strings found in src/"; exit 1)

- name: Disallow legacy imports
  run: |
    ! rg -n "from '.*legacy" -g "src/**/*.ts" || \
      (echo "❌ src imports legacy/*"; exit 1)
```

#### 1.4 Deprecation Tracker
**File**: `DEPRECATION_TRACKER.md`

| File (original path) | Reason | Replacement/Plan | Status | Drop by |
|---|---|---|---|---|
| services/model_manager_intel.py | Placeholder ML loading | LMStudio-only path | Quarantine | 2025-09-15 |
| services/smolvlm_optimized_service.py | Incomplete ONNX | Same as above | Quarantine | 2025-09-15 |
| src/ImageValidationService.ts | Placeholder validation | BasicValidation.ts | Quarantine | 2025-09-08 |
| src/ImageProcessor.ts | OpenCV TODOs | OpenCvImageProcessor.ts | Quarantine | 2025-09-01 |

### Phase 2: Architecture Foundation
**Objective**: Establish clean ports/adapters pattern with working implementations

#### 2.1 Dependency Cruiser Configuration
**File**: `tools/depcruise.config.cjs`
- Forbid imports from legacy anywhere
- Core interfaces cannot depend on adapters/app
- Only wiring.ts can mix adapters and core
- Generate SVG dependency graphs

#### 2.2 Port Interfaces
**Core Abstractions**:
```typescript
// src/core/image/ImageProcessorPort.ts
export interface ImageProcessorPort {
  enhance(inputPath: string): Promise<{ outputPath: string; meta: { rotation?: number } }>;
  validate(inputPath: string): Promise<{ ok: boolean; reasons?: string[] }>;
}

// src/core/infer/InferencePort.ts  
export interface InferencePort {
  classify(imagePath: string, options?: { signal?: AbortSignal }): Promise<{
    card_title: string;
    identifier: { number?: string; set_size?: string; promo_code?: string };
    set_name?: string;
    first_edition?: boolean;
    confidence: number;
    raw?: any;
  }>;
}
```

#### 2.3 Production Adapters
**OpenCV Image Processing**:
- **File**: `src/adapters/opencv/OpenCvImageProcessor.ts`
- **Operations**: CLAHE contrast enhancement, bilateral denoising, auto-rotation
- **Python Helpers**: `scripts/opencv_enhance.py`, `scripts/opencv_validate.py`
- **Validation**: Resolution checks, aspect ratio validation (63:88 ±10%)

**LMStudio Inference**:
- **File**: `src/adapters/lmstudio/LmStudioInference.ts`
- **Endpoint**: `http://10.0.24.174:1234/v1/chat/completions`
- **Circuit Breaker**: Integration with existing error handling
- **Timeout**: AbortSignal support for request cancellation

#### 2.4 TypeScript Path Aliases
```json
// tsconfig.json
"paths": {
  "@core/*": ["src/core/*"],
  "@adapters/*": ["src/adapters/*"],
  "@app/*": ["src/app/*"]
}
```

### Phase 3: Code Migration
**Objective**: Replace concrete imports with dependency injection

#### 3.1 Composition Root
**File**: `src/app/wiring.ts`
```typescript
export type Ports = {
  image: ImageProcessorPort;
  infer: InferencePort;
  // validate: ValidationPort;
  // persist: PersistencePort;
};

export const ports: Ports = {
  image: new OpenCvImageProcessor(),
  infer: new LmStudioInference(LM_BASE, LM_MODEL),
};
```

#### 3.2 JSCodeshift Migration
**File**: `tools/codemods/ports-injection.ts`
- Automated replacement of concrete imports
- Injection of port interfaces and wiring imports
- Type annotation preservation
- **Usage**: `npm run codemod:ports`

#### 3.3 Environment Configuration
```bash
# .env additions
REMOTE_ML_HOST=10.0.24.174
REMOTE_ML_PORT=1234
LMSTUDIO_MODEL=cardmint-baseline
CARDMINT_PROFILE=dev|demo|prod|mock
```

### Phase 4: CI Safety Rails
**Objective**: Prevent architectural regression and maintain code quality

#### 4.1 Architecture Lint Integration
- **Tool**: dependency-cruiser
- **Rules**: No legacy imports, clean layer separation
- **Output**: SVG dependency graphs, error reports
- **CI**: Fail builds on architecture violations

#### 4.2 Automated Quality Gates
```yaml
- name: Architecture lint
  run: |
    npx depcruise --validate tools/depcruise.config.cjs src \
      --exclude '^legacy|^dist|^tests|^scripts' \
      --output-type err

- name: Dead code detection  
  run: npx ts-prune | tee artifacts/ts-prune.txt; test ! -s artifacts/ts-prune.txt
```

#### 4.3 Golden Test Suite
- **Requirement**: Use only live adapters (no legacy, no placeholders)
- **Dataset**: 10-card manifest from existing golden files
- **Metrics**: Processing time, accuracy, resource usage
- **Reporting**: HTML reports with performance trends

### Phase 5: Verification & Cleanup
**Objective**: Complete migration and establish maintenance processes

#### 5.1 Migration Verification
```bash
# Verification commands
npx eslint "src/**/*.{ts,tsx}"          # No lint violations
! rg -n "legacy/" -g "src/**/*.ts"      # No legacy imports  
! rg -n "PLACEHOLDER|NOT IMPLEMENTED" src  # No placeholders
task archlint                           # Clean architecture
```

#### 5.2 Performance Validation
- **Baseline**: Current OCR 12-17 seconds
- **Target**: <3 seconds total processing
- **Monitoring**: Resource usage, memory leaks, CPU utilization
- **Alerts**: Automatic rollback on performance degradation

#### 5.3 Documentation & ADRs
- **Architecture Decision Records**: Document major refactoring decisions
- **API Documentation**: Updated endpoint specifications  
- **Deployment Guide**: Environment setup and configuration
- **Troubleshooting**: Common issues and solutions

## Technical Specifications

### File Structure (Post-Migration)
```
src/
├── core/                    # Pure interfaces (ports)
│   ├── image/
│   │   └── ImageProcessorPort.ts
│   ├── infer/
│   │   └── InferencePort.ts
│   └── validate/
│       └── ValidationPort.ts
├── adapters/               # Concrete implementations
│   ├── opencv/
│   │   └── OpenCvImageProcessor.ts
│   ├── lmstudio/
│   │   └── LmStudioInference.ts
│   └── validation/
│       └── BasicValidation.ts
├── app/                    # Composition & wiring
│   └── wiring.ts
└── config/
    └── features.ts

legacy/                     # Quarantined code (DO NOT IMPORT)
├── ml/
├── image/
└── validation/

tools/
├── depcruise.config.cjs    # Architecture lint rules
└── codemods/
    └── ports-injection.ts  # Migration automation

scripts/
├── opencv_enhance.py       # Image processing helpers
├── opencv_validate.py     # Validation helpers
└── emergency-rollback.sh   # Safety scripts
```

### NPM Scripts
```json
{
  "codemod:ports": "npx jscodeshift -t tools/codemods/ports-injection.ts 'src/**/*.ts'",
  "depgraph": "npx madge --extensions ts,tsx --image artifacts/depgraph.svg src", 
  "archlint": "npx depcruise --validate tools/depcruise.config.cjs src --output-type err",
  "ts-prune": "npx ts-prune",
  "precommit": "npm run lint && npm run ts-prune && npm run archlint"
}
```

### Taskfile Commands
```yaml
up:           # Install dependencies
config:doctor: # Validate configuration
codemod:ports: # Run port injection codemod  
depgraph:     # Generate dependency graph
archlint:     # Architecture validation
e2e:golden:   # Run golden test suite
```

## Implementation Runbook

### Day 1: Safety Setup
```bash
# Create checkpoint
git switch -c cleanup/2025-08-25-deprecation
git tag -a v0.5.0-pre-deprecation -m "Checkpoint before deprecation sweep"

# Create archives
mkdir -p ../cardmint-archives
git archive --format=zip --output ../cardmint-archives/cardmint-predep-2025-08-25.zip HEAD
git bundle create ../cardmint-archives/cardmint-2025-08-25.bundle --all
```

### Day 2: Framework Setup
```bash
# Install dependencies
npm install dependency-cruiser jscodeshift @types/jscodeshift

# Create directory structure  
mkdir -p legacy/{ml,image,validation}
mkdir -p src/{core,adapters,app}/{image,infer,validate}
mkdir -p tools/{codemods} scripts artifacts

# Apply configuration patches
# (ESLint rules, tsconfig paths, depcruise config)
```

### Day 3: Code Migration
```bash
# Move legacy files
git mv services/model_manager_intel.py legacy/ml/
git mv services/smolvlm_optimized_service.py legacy/ml/

# Run codemod
npm run codemod:ports

# Verify changes
npm run lint
npm run archlint
```

### Day 4: Integration & Testing
```bash
# Configure environment
export REMOTE_ML_HOST=10.0.24.174
export REMOTE_ML_PORT=1234 
export LMSTUDIO_MODEL=cardmint-baseline

# Test adapters
node -e "import('./dist/app/wiring.js').then(async ({ports})=>{
  const r = await ports.infer.classify('golden/images/blissey.jpg');
  console.log('Success:', r.card_title, r.identifier);
})"

# Run golden suite
task e2e:golden
```

### Day 5: Verification & Cleanup
```bash
# Final verification
npx eslint "src/**/*.{ts,tsx}"
! rg -n "legacy/" -g "src/**/*.ts"  
! rg -n "PLACEHOLDER|NOT IMPLEMENTED" src
task archlint
npm run depgraph

# Update documentation
# Complete DEPRECATION_TRACKER.md
# Create ADRs for major decisions
```

## Success Criteria & Metrics

### Technical Metrics
- ✅ **Zero ESLint violations**: Clean code standards enforced
- ✅ **Zero legacy imports**: Complete separation of old/new code  
- ✅ **Zero placeholder strings**: All production code implemented
- ✅ **Clean architecture**: dependency-cruiser reports 0 violations
- ✅ **Golden tests pass**: 10-card suite completes successfully

### Performance Metrics  
- ✅ **Processing time**: Maintain or improve current performance
- ✅ **Memory usage**: No memory leaks or excessive consumption
- ✅ **CPU utilization**: Efficient resource usage
- ✅ **Response time**: API endpoints remain responsive

### Process Metrics
- ✅ **CI pipeline**: All quality gates pass
- ✅ **Rollback capability**: Emergency rollback tested and verified
- ✅ **Documentation**: Complete ADRs and updated guides
- ✅ **Team handoff**: Clear maintenance procedures established

## Risk Mitigation

### Technical Risks
- **Performance Degradation**: Automatic rollback at 10s threshold
- **Memory Pressure**: Model swapping and cache eviction policies
- **CPU Saturation**: Dynamic worker scaling and resource monitoring
- **Integration Failures**: Circuit breaker patterns and timeout handling

### Process Risks  
- **Incomplete Migration**: Comprehensive verification scripts and checklists
- **Knowledge Loss**: Complete documentation and ADR creation
- **Regression Introduction**: CI gates and automated quality checks
- **Production Impact**: Feature flags and gradual rollout strategy

## Future Roadmap

### Phase 6: Advanced Optimizations (Post-Cleanup)
- **ONNX Integration**: Add as CPU fallback inference adapter
- **GPU Support**: CUDA adapter for 10x faster inference
- **Advanced Caching**: Redis-backed result caching
- **Monitoring**: APM integration and performance dashboards

### Phase 7: Production Hardening
- **Load Testing**: Stress testing with realistic workloads  
- **Security Audit**: Vulnerability scanning and security review
- **Deployment Automation**: CI/CD pipeline for production releases
- **Monitoring & Alerting**: Comprehensive observability stack

## Conclusion

This comprehensive audit and cleanup transforms CardMint from a prototype with significant technical debt into a production-ready system with clean architecture, automated quality gates, and maintainable code. The systematic approach ensures zero production impact while establishing a solid foundation for future development.

The emphasis on safety (checkpoints, rollback capability), quality (CI gates, architecture lint), and maintainability (ports/adapters, dependency injection) creates a robust system that can evolve without accumulating technical debt.

**Next Steps**: Begin implementation with Phase 0 safety infrastructure, then proceed sequentially through each phase with careful verification at each step.

---

*This document serves as the definitive guide for CardMint's architectural transformation and should be referenced throughout the implementation process.*